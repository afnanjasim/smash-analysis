# SMASH-analysis

The SMASH-analysis suite contains various tools and scripts useful to compute
different observables from the output generated by the
[SMASH](https://smash-transport.github.io) transport code. Most of this scripts
are written in python. The latest results
extracted by means of the SMASH-analysis suite, can be found
[here](http://theory.gsi.de/~smash/analysis_suite/current/).

Among the observables and cross-checks that are extracted with the scripts in
this repository are:
- **Angular Distributions** <br/>
  Non-isotropic cross sections of NN &leftrightarrow; NÎ” scatterings.
- **Cross Sections**<br/>
  Inclusive and exclusive cross sections for different
  elementary scattering processes.
- **Detailed Balance**<br/>
  Detailed balance tests in an infinite matter simulation (box) with different
  particle species.
- **Dileptons**<br/>
  Invariant mass spectra for dileptons from different elementary and heavy-ion
  collisions.
- **Scattering Rates**<br/>
  Analysis of scattering rates in infinite matter simulations with only elastic
  collisions.
- **Energy Scan**<br/>
  Multiplicities, midrapidity yields, transverse momentum and rapidity spectra
  for the most abundant hadron species over a large range of beam energies.
- **FOPI Pions**<br/>
  Pion multiplicities and transverse momentum spectra following the FOPI
  experiment.


## Prerequisites
Running SMASH for the above listed observables to generate the necessary data
sets is embedded in the SMASH-analysis suite. As such, the SMASH source
code (if run on a cluster), or at least the SMASH binary needs to be accessible
from where the SMASH-analysis suite is executed.
The SMASH source code as well as further instructions how to download and
compile it can be found [here](https://github.com/smash-transport/smash).

Thus, SMASH-analysis suite requires the following tools:
- SMASH version = (SMASH-analysis version)
- cmake version &ge; 3.13

The SMASH-analysis suite is regularly tagged (SMASH-ana-1.6 and later),
where it is ensured that the SMASH-analysis version is compatible with the
same version of the SMASH transport code. Please make sure to use compatible
versions.

Furthermore, Python 2.7.x is necesssary with the following modules:

- [numpy](www.numpy.org) version &ge; 1.6.2
- [scipy](www.scipy.org) version &ge; 0.10.1
- [matplotlib](www.matplotlib.org) version &ge; 1.3.1
- [argparse](https://docs.python.org/3/library/argparse.html) version &ge; 1.1
- [pyyaml](www.pyyaml.org) version &ge; 3.11
- [pandas](www.pandas.pydata.org) version &ge; 0.14.1

Python 3 is currently not supported. The versions of Python and the different
modules can be determined by running the script `version_check.py` located in
the `smash-analysis/python_scripts` directory. The versions listed above are the
smallest versions that have been verified to work. Any missing python modules
(e.g. pandas) can be installed via the python package installer
[pip](https://pypi.org/project/pip/):

    pip install --user pandas

For further details, see
[here](http://pip.readthedocs.org/en/latest/reference/pip_install.html).
If the pip module itself is not available, it can be installed via

    wget https://bootstrap.pypa.io/get-pip.py
    python get-pip.py --user

Then the remaining modules (e.g. pandas) can be installed via:

    python -m pip install --user pandas

In order to install a particular version of a module (e.g. version 0.14.1 of
pandas), execute:

    python -m pip install --user pandas==0.14.1

For plotting, the DejaVu font is used by default. If font problems in plots
arise, it may be downloaded [here](https://dejavu-fonts.github.io).
After downloading, the font needs to be installed on the system.
It might also be necessary to delete the local matplotlib font cache.


## Building the SMASH-analysis suite

Use the following commands to create all subtargets of the SMASH-analysis suite
in a separate `build` directory:

    mkdir build
    cd build
    cmake .. -DSMASH_PATH=[...]/smash/build

All subtargets of the analysis suite have been created by `cmake`.

Note though, that most of them are split into simulation targets (`sims`),
analysis targets (`analysis`) and plotting targets (`plots`). This bears the
advantage that the SMASH simulations need not be run again if the date of last
modification has changed because the files where touched unrelated to code
modifications. On the other hand, this procedure requires three
subtargets to be executed one after the other to yield the final plots. In the
example of the scattering rates (called 'elastic_box'), this means the following
commands need to be executed in the appropriate order:

    make elastic_box_sims -jN
    make elastic_box_analysis -jN
    make elastic_box_plots -jN

Where N corresponds to the number of cores, if the SMASH-analysis suite is run
in parallel.

The above described splitting applies to the following targets:
- `angular_distributions`
- `cross_sections`
- `detailed_balance`
- `elastic_box`
- `energy_scan`

In the case of FOPI Pions, there are only two subtargets:

    make FOPI_pions_sims -jN
    make FOPI_pions_plots -jN

And for the dileptons there is only one single target:

    make dileptons -jN

Note, that all dilepton data files generated during the SMASH run are
immediately removed once they have been analyzed, as they are exceptionally
large.   

## Running the SMASH-analysis suite on a SLURM cluster

As most of the targets have a significant runtime (some of them up to several
days), it is recommended to run the SMASH-analysis on a cluster. An exemplary
slurm script, `slurm-job.sh`, is provided in the `smash-analysis`
directory. It may be used and adapted. Note that in this case, also SMASH is
compiled on the computing note.

To submit all the above mentioned targets instantaneously to the cluster, the
script `submit_to_slurm.sh` may be useful. It can be executed via

    ./submit-to-slurm.sh [...]/smash [...]/eigen all [...]/output_dir

where the path to the SMASH directory, the path to the eigen directory, the
target (`all` in this case, such that all targets are being executed) and,
if desired, the path to the output directory are being passed
from the command line.

In case SMASH crashes for some reason, there will be stale lock files which
prevent SMASH to be run again in the same directory. They can be deleted via

    find [...]/output_dir -type f -name smash.lock -exec rm {} \;



## Creating the webpage

Combining all generated plots in an html page has proven to be most suitable
to easily compare the yielded results. 
